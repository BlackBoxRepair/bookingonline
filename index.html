let bookingData = { store: '', date: '', time: '', startH: 0, endH: 0 };

        // 初始化日期範圍
        function initDatePicker() {
            const dateInput = document.getElementById('bookDate');
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + 60);
            
            dateInput.min = today.toISOString().split('T')[0];
            dateInput.max = maxDate.toISOString().split('T')[0];
        }

        // 核心修正：選擇門市時立即清空所有舊資料
        function selectStore(name, start, end) {
            // 1. 設定新門市的時間範圍
            bookingData.store = name;
            bookingData.startH = start;
            bookingData.endH = end;

            // 2. 徹底清空舊有的選擇紀錄
            bookingData.date = '';
            bookingData.time = '';
            document.getElementById('bookDate').value = ''; // 清空日期輸入框
            document.getElementById('timeSlots').innerHTML = ''; // 移除舊時段按鈕
            resetNextBtn(); // 讓下一步按鈕變回灰色

            // 3. 進入第二步並初始化日曆
            toStep(2);
            initDatePicker();
        }

        function generateTimeSlots() {
            const dateVal = document.getElementById('bookDate').value;
            bookingData.date = dateVal;
            const container = document.getElementById('timeSlots');
            container.innerHTML = ''; // 每次日期變動也清空一次時段
            
            if (!dateVal) return;

            // 根據 selectStore 傳入的 startH 與 endH 生成時段
            for (let h = bookingData.startH; h <= bookingData.endH; h++) {
                ['00', '30'].forEach(m => {
                    // 勤美(11-19) 或 沙鹿(12-20)
                    if (h === bookingData.endH && m === '30') return; 
                    
                    const time = `${h}:${m}`;
                    const btn = document.createElement('button');
                    btn.className = 'time-slot py-3 rounded-lg font-bold text-sm';
                    btn.innerText = time;
                    btn.onclick = () => setTime(time, btn);
                    container.appendChild(btn);
                });
            }
            resetNextBtn(); // 生成新時段後，必須重新選時間才能按下一步
        }

        function setTime(time, el) {
            bookingData.time = time;
            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = false;
            nextBtn.className = "w-full mt-8 bg-blue-600 text-white py-4 rounded-xl font-bold shadow-md";
        }

        function resetNextBtn() {
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = true;
            nextBtn.className = "w-full mt-8 bg-gray-200 text-gray-400 py-4 rounded-xl font-bold";
        }

        function toStep(step) {
            document.getElementById('step-1').classList.add('hidden');
            document.getElementById('step-2').classList.add('hidden');
            document.getElementById('step-3').classList.add('hidden');
            document.getElementById('step-' + step).classList.remove('hidden');
            document.getElementById('nav-bar').classList.toggle('hidden', step === 1);
            window.scrollTo(0,0);
        }

        function goBack() {
            const cur = document.querySelector('div[id^="step-"]:not(.hidden)').id;
            if(cur === 'step-2') toStep(1);
            else if(cur === 'step-3') toStep(2);
        }
