// 1. 修改取得台灣今日日期的邏輯 (確保 YYYY-MM-DD 格式完全正確)
const getToday = () => {
    const now = new Date();
    // 強制轉為台灣時區並取得 ISO 字串的前 10 位
    const offset = 8 * 60; // 台灣 UTC+8
    const localTime = new Date(now.getTime() + (offset + now.getTimezoneOffset()) * 60000);
    const y = localTime.getFullYear();
    const m = String(localTime.getMonth() + 1).padStart(2, '0');
    const d = String(localTime.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
};

// 2. 修改選擇門市後的初始化邏輯 (確保 min 屬性正確寫入)
function selectStore(n, s, e) {
    bookingData = { store: n, startH: s, endH: e, date: '', time: '' };
    const dateInput = document.getElementById('bookDate');
    
    // 先清空值，避免舊資料干擾
    dateInput.value = '';
    document.getElementById('timeSlots').innerHTML = '';
    
    // 關鍵修復：設定 min 屬性並移除可能干擾的屬性
    const todayStr = getToday();
    dateInput.setAttribute('min', todayStr);
    
    updateNextBtnStatus();
    toStep(2);
    saveDraft();
}

// 3. 增加一個強制喚起日曆的輔助 (針對某些手機瀏覽器)
document.getElementById('bookDate').addEventListener('click', function() {
    if (this.showPicker) {
        this.showPicker(); // 強制開啟原生選擇器
    }
});
